; Listing generated by Microsoft (R) Optimizing Compiler Version 16.00.40219.01 

	TITLE	C:\workspace\Putty\windows\winnpc.c
	.686P
	.XMM
	include listing.inc
	.model	flat

INCLUDELIB LIBCMTD
INCLUDELIB OLDNAMES

_DATA	SEGMENT
$SG88011 DB	'\\.\pipe\', 00H
	ORG $+2
$SG88012 DB	'.', 00H, '.', 00H, '\', 00H, '.', 00H, '.', 00H, '\', 00H
	DB	'w', 00H, 'i', 00H, 'n', 00H, 'n', 00H, 'p', 00H, 'c', 00H, '.'
	DB	00H, 'c', 00H, 00H, 00H
	ORG $+6
$SG88013 DB	's', 00H, 't', 00H, 'r', 00H, 'n', 00H, 'c', 00H, 'm', 00H
	DB	'p', 00H, '(', 00H, 'p', 00H, 'i', 00H, 'p', 00H, 'e', 00H, 'n'
	DB	00H, 'a', 00H, 'm', 00H, 'e', 00H, ',', 00H, ' ', 00H, '"', 00H
	DB	'\', 00H, '\', 00H, '\', 00H, '\', 00H, '.', 00H, '\', 00H, '\'
	DB	00H, 'p', 00H, 'i', 00H, 'p', 00H, 'e', 00H, '\', 00H, '\', 00H
	DB	'"', 00H, ',', 00H, ' ', 00H, '9', 00H, ')', 00H, ' ', 00H, '='
	DB	00H, '=', 00H, ' ', 00H, '0', 00H, 00H, 00H
	ORG $+2
$SG88016 DB	'.', 00H, '.', 00H, '\', 00H, '.', 00H, '.', 00H, '\', 00H
	DB	'w', 00H, 'i', 00H, 'n', 00H, 'n', 00H, 'p', 00H, 'c', 00H, '.'
	DB	00H, 'c', 00H, 00H, 00H
	ORG $+2
$SG88017 DB	's', 00H, 't', 00H, 'r', 00H, 'c', 00H, 'h', 00H, 'r', 00H
	DB	'(', 00H, 'p', 00H, 'i', 00H, 'p', 00H, 'e', 00H, 'n', 00H, 'a'
	DB	00H, 'm', 00H, 'e', 00H, ' ', 00H, '+', 00H, ' ', 00H, '9', 00H
	DB	',', 00H, ' ', 00H, '''', 00H, '\', 00H, '\', 00H, '''', 00H, ')'
	DB	00H, ' ', 00H, '=', 00H, '=', 00H, ' ', 00H, 'N', 00H, 'U', 00H
	DB	'L', 00H, 'L', 00H, 00H, 00H
	ORG $+2
$SG88027 DB	'Unable to open named pipe ''%s'': %s', 00H
	ORG $+1
$SG88029 DB	'Error waiting for named pipe ''%s'': %s', 00H
	ORG $+2
$SG88032 DB	'Unable to get user SID', 00H
	ORG $+1
$SG88037 DB	'Unable to get named pipe security information: %s', 00H
	ORG $+2
$SG88039 DB	'Owner of named pipe ''%s'' is not us', 00H
_DATA	ENDS
PUBLIC	_new_named_pipe_client
EXTRN	_make_handle_socket:PROC
EXTRN	__imp__LocalFree@4:PROC
EXTRN	__imp__EqualSid@8:PROC
EXTRN	_p_GetSecurityInfo:DWORD
EXTRN	__imp__CloseHandle@4:PROC
EXTRN	_get_user_sid:PROC
EXTRN	__imp__WaitNamedPipeA@8:PROC
EXTRN	_safefree:PROC
EXTRN	_new_error_socket:PROC
EXTRN	_dupprintf:PROC
EXTRN	_win_strerror:PROC
EXTRN	__imp__GetLastError@0:PROC
EXTRN	__imp__CreateFileA@28:PROC
EXTRN	_strchr:PROC
EXTRN	__wassert:PROC
EXTRN	_strncmp:PROC
EXTRN	@_RTC_CheckStackVars@8:PROC
EXTRN	__RTC_CheckEsp:PROC
EXTRN	__RTC_Shutdown:PROC
EXTRN	__RTC_InitBase:PROC
;	COMDAT rtc$TMZ
; File c:\workspace\putty\windows\winnpc.c
rtc$TMZ	SEGMENT
__RTC_Shutdown.rtc$TMZ DD FLAT:__RTC_Shutdown
rtc$TMZ	ENDS
;	COMDAT rtc$IMZ
rtc$IMZ	SEGMENT
__RTC_InitBase.rtc$IMZ DD FLAT:__RTC_InitBase
; Function compile flags: /Odtp /RTCsu
rtc$IMZ	ENDS
_TEXT	SEGMENT
_ret$ = -40						; size = 4
_err$ = -36						; size = 4
_psd$ = -28						; size = 4
_pipeowner$ = -16					; size = 4
_usersid$ = -8						; size = 4
_pipehandle$ = -4					; size = 4
_pipename$ = 8						; size = 4
_plug$ = 12						; size = 4
_new_named_pipe_client PROC
; Line 23
	push	ebp
	mov	ebp, esp
	sub	esp, 40					; 00000028H
	push	esi
	push	edi
	lea	edi, DWORD PTR [ebp-40]
	mov	ecx, 10					; 0000000aH
	mov	eax, -858993460				; ccccccccH
	rep stosd
; Line 30
	push	9
	push	OFFSET $SG88011
	mov	eax, DWORD PTR _pipename$[ebp]
	push	eax
	call	_strncmp
	add	esp, 12					; 0000000cH
	test	eax, eax
	je	SHORT $LN11@new_named_
	push	30					; 0000001eH
	push	OFFSET $SG88012
	push	OFFSET $SG88013
	call	__wassert
	add	esp, 12					; 0000000cH
$LN11@new_named_:
; Line 31
	push	92					; 0000005cH
	mov	edx, DWORD PTR _pipename$[ebp]
	add	edx, 9
	push	edx
	call	_strchr
	add	esp, 8
	test	eax, eax
	je	SHORT $LN8@new_named_
	push	31					; 0000001fH
	push	OFFSET $SG88016
	push	OFFSET $SG88017
	call	__wassert
	add	esp, 12					; 0000000cH
$LN8@new_named_:
; Line 33
	mov	ecx, 1
	test	ecx, ecx
	je	$LN7@new_named_
; Line 36
	mov	esi, esp
	push	0
	push	1073741824				; 40000000H
	push	3
	push	0
	push	0
	push	-1073741824				; c0000000H
	mov	edx, DWORD PTR _pipename$[ebp]
	push	edx
	call	DWORD PTR __imp__CreateFileA@28
	cmp	esi, esp
	call	__RTC_CheckEsp
	mov	DWORD PTR _pipehandle$[ebp], eax
; Line 38
	cmp	DWORD PTR _pipehandle$[ebp], -1
	je	SHORT $LN6@new_named_
; Line 39
	jmp	$LN7@new_named_
$LN6@new_named_:
; Line 41
	mov	esi, esp
	call	DWORD PTR __imp__GetLastError@0
	cmp	esi, esp
	call	__RTC_CheckEsp
	cmp	eax, 231				; 000000e7H
	je	SHORT $LN5@new_named_
; Line 43
	mov	esi, esp
	call	DWORD PTR __imp__GetLastError@0
	cmp	esi, esp
	call	__RTC_CheckEsp
	push	eax
	call	_win_strerror
	add	esp, 4
	push	eax
	mov	eax, DWORD PTR _pipename$[ebp]
	push	eax
	push	OFFSET $SG88027
	call	_dupprintf
	add	esp, 12					; 0000000cH
	mov	DWORD PTR _err$[ebp], eax
; Line 44
	mov	ecx, DWORD PTR _plug$[ebp]
	push	ecx
	mov	edx, DWORD PTR _err$[ebp]
	push	edx
	call	_new_error_socket
	add	esp, 8
	mov	DWORD PTR _ret$[ebp], eax
; Line 45
	mov	eax, DWORD PTR _err$[ebp]
	push	eax
	call	_safefree
	add	esp, 4
; Line 46
	mov	eax, DWORD PTR _ret$[ebp]
	jmp	$LN9@new_named_
$LN5@new_named_:
; Line 56
	mov	esi, esp
	push	0
	mov	ecx, DWORD PTR _pipename$[ebp]
	push	ecx
	call	DWORD PTR __imp__WaitNamedPipeA@8
	cmp	esi, esp
	call	__RTC_CheckEsp
	test	eax, eax
	jne	SHORT $LN4@new_named_
; Line 58
	mov	esi, esp
	call	DWORD PTR __imp__GetLastError@0
	cmp	esi, esp
	call	__RTC_CheckEsp
	push	eax
	call	_win_strerror
	add	esp, 4
	push	eax
	mov	edx, DWORD PTR _pipename$[ebp]
	push	edx
	push	OFFSET $SG88029
	call	_dupprintf
	add	esp, 12					; 0000000cH
	mov	DWORD PTR _err$[ebp], eax
; Line 59
	mov	eax, DWORD PTR _plug$[ebp]
	push	eax
	mov	ecx, DWORD PTR _err$[ebp]
	push	ecx
	call	_new_error_socket
	add	esp, 8
	mov	DWORD PTR _ret$[ebp], eax
; Line 60
	mov	edx, DWORD PTR _err$[ebp]
	push	edx
	call	_safefree
	add	esp, 4
; Line 61
	mov	eax, DWORD PTR _ret$[ebp]
	jmp	$LN9@new_named_
$LN4@new_named_:
; Line 63
	jmp	$LN8@new_named_
$LN7@new_named_:
; Line 65
	call	_get_user_sid
	mov	DWORD PTR _usersid$[ebp], eax
	cmp	DWORD PTR _usersid$[ebp], 0
	jne	SHORT $LN3@new_named_
; Line 66
	mov	esi, esp
	mov	eax, DWORD PTR _pipehandle$[ebp]
	push	eax
	call	DWORD PTR __imp__CloseHandle@4
	cmp	esi, esp
	call	__RTC_CheckEsp
; Line 67
	push	OFFSET $SG88032
	call	_dupprintf
	add	esp, 4
	mov	DWORD PTR _err$[ebp], eax
; Line 68
	mov	ecx, DWORD PTR _plug$[ebp]
	push	ecx
	mov	edx, DWORD PTR _err$[ebp]
	push	edx
	call	_new_error_socket
	add	esp, 8
	mov	DWORD PTR _ret$[ebp], eax
; Line 69
	mov	eax, DWORD PTR _err$[ebp]
	push	eax
	call	_safefree
	add	esp, 4
; Line 70
	mov	eax, DWORD PTR _ret$[ebp]
	jmp	$LN9@new_named_
$LN3@new_named_:
; Line 76
	mov	esi, esp
	lea	ecx, DWORD PTR _psd$[ebp]
	push	ecx
	push	0
	push	0
	push	0
	lea	edx, DWORD PTR _pipeowner$[ebp]
	push	edx
	push	1
	push	6
	mov	eax, DWORD PTR _pipehandle$[ebp]
	push	eax
	call	DWORD PTR _p_GetSecurityInfo
	cmp	esi, esp
	call	__RTC_CheckEsp
	test	eax, eax
	je	SHORT $LN2@new_named_
; Line 78
	mov	esi, esp
	call	DWORD PTR __imp__GetLastError@0
	cmp	esi, esp
	call	__RTC_CheckEsp
	push	eax
	call	_win_strerror
	add	esp, 4
	push	eax
	push	OFFSET $SG88037
	call	_dupprintf
	add	esp, 8
	mov	DWORD PTR _err$[ebp], eax
; Line 79
	mov	ecx, DWORD PTR _plug$[ebp]
	push	ecx
	mov	edx, DWORD PTR _err$[ebp]
	push	edx
	call	_new_error_socket
	add	esp, 8
	mov	DWORD PTR _ret$[ebp], eax
; Line 80
	mov	eax, DWORD PTR _err$[ebp]
	push	eax
	call	_safefree
	add	esp, 4
; Line 81
	mov	esi, esp
	mov	ecx, DWORD PTR _pipehandle$[ebp]
	push	ecx
	call	DWORD PTR __imp__CloseHandle@4
	cmp	esi, esp
	call	__RTC_CheckEsp
; Line 82
	mov	edx, DWORD PTR _usersid$[ebp]
	push	edx
	call	_safefree
	add	esp, 4
; Line 83
	mov	eax, DWORD PTR _ret$[ebp]
	jmp	$LN9@new_named_
$LN2@new_named_:
; Line 86
	mov	esi, esp
	mov	eax, DWORD PTR _usersid$[ebp]
	push	eax
	mov	ecx, DWORD PTR _pipeowner$[ebp]
	push	ecx
	call	DWORD PTR __imp__EqualSid@8
	cmp	esi, esp
	call	__RTC_CheckEsp
	test	eax, eax
	jne	SHORT $LN1@new_named_
; Line 87
	mov	edx, DWORD PTR _pipename$[ebp]
	push	edx
	push	OFFSET $SG88039
	call	_dupprintf
	add	esp, 8
	mov	DWORD PTR _err$[ebp], eax
; Line 88
	mov	eax, DWORD PTR _plug$[ebp]
	push	eax
	mov	ecx, DWORD PTR _err$[ebp]
	push	ecx
	call	_new_error_socket
	add	esp, 8
	mov	DWORD PTR _ret$[ebp], eax
; Line 89
	mov	edx, DWORD PTR _err$[ebp]
	push	edx
	call	_safefree
	add	esp, 4
; Line 90
	mov	esi, esp
	mov	eax, DWORD PTR _pipehandle$[ebp]
	push	eax
	call	DWORD PTR __imp__CloseHandle@4
	cmp	esi, esp
	call	__RTC_CheckEsp
; Line 91
	mov	esi, esp
	mov	ecx, DWORD PTR _psd$[ebp]
	push	ecx
	call	DWORD PTR __imp__LocalFree@4
	cmp	esi, esp
	call	__RTC_CheckEsp
; Line 92
	mov	edx, DWORD PTR _usersid$[ebp]
	push	edx
	call	_safefree
	add	esp, 4
; Line 93
	mov	eax, DWORD PTR _ret$[ebp]
	jmp	SHORT $LN9@new_named_
$LN1@new_named_:
; Line 96
	mov	esi, esp
	mov	eax, DWORD PTR _psd$[ebp]
	push	eax
	call	DWORD PTR __imp__LocalFree@4
	cmp	esi, esp
	call	__RTC_CheckEsp
; Line 97
	mov	ecx, DWORD PTR _usersid$[ebp]
	push	ecx
	call	_safefree
	add	esp, 4
; Line 99
	push	1
	mov	edx, DWORD PTR _plug$[ebp]
	push	edx
	mov	eax, DWORD PTR _pipehandle$[ebp]
	push	eax
	mov	ecx, DWORD PTR _pipehandle$[ebp]
	push	ecx
	call	_make_handle_socket
	add	esp, 16					; 00000010H
$LN9@new_named_:
; Line 100
	push	edx
	mov	ecx, ebp
	push	eax
	lea	edx, DWORD PTR $LN16@new_named_
	call	@_RTC_CheckStackVars@8
	pop	eax
	pop	edx
	pop	edi
	pop	esi
	add	esp, 40					; 00000028H
	cmp	ebp, esp
	call	__RTC_CheckEsp
	mov	esp, ebp
	pop	ebp
	ret	0
	npad	2
$LN16@new_named_:
	DD	2
	DD	$LN15@new_named_
$LN15@new_named_:
	DD	-16					; fffffff0H
	DD	4
	DD	$LN13@new_named_
	DD	-28					; ffffffe4H
	DD	4
	DD	$LN14@new_named_
$LN14@new_named_:
	DB	112					; 00000070H
	DB	115					; 00000073H
	DB	100					; 00000064H
	DB	0
$LN13@new_named_:
	DB	112					; 00000070H
	DB	105					; 00000069H
	DB	112					; 00000070H
	DB	101					; 00000065H
	DB	111					; 0000006fH
	DB	119					; 00000077H
	DB	110					; 0000006eH
	DB	101					; 00000065H
	DB	114					; 00000072H
	DB	0
_new_named_pipe_client ENDP
_TEXT	ENDS
END
